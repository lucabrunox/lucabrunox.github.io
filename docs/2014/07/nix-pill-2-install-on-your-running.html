<!doctype html>































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-us"
  dir="ltr"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Nix pill 2: install on your running system - Luca Bruno blog</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra." />
  <meta name="author" content="Luca Bruno blog" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://lucabrun.github.io/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="https://lucabrun.github.io/theme.png" />

  
  
  
  
  

  
  
  

  
  
  <script
    defer
    src="https://lucabrun.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link
    rel="icon"
    href="https://lucabrun.github.io/favicon.ico"
  />
  <link
    rel="apple-touch-icon"
    href="https://lucabrun.github.io/apple-touch-icon.png"
  />

  
  <meta name="generator" content="Hugo 0.125.2">

  
  
  
  
  


  
  
  <meta itemprop="name" content="Nix pill 2: install on your running system">
  <meta itemprop="description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">
  <meta itemprop="datePublished" content="2014-07-24T08:38:00-07:00">
  <meta itemprop="dateModified" content="2014-07-24T08:38:00-07:00">
  <meta itemprop="wordCount" content="1231">
  <meta itemprop="keywords" content="Nixpkgs,Nix,Nixpills,Nixos">
  
  <meta property="og:url" content="https://lucabrun.github.io/2014/07/nix-pill-2-install-on-your-running.html">
  <meta property="og:site_name" content="Luca Bruno blog">
  <meta property="og:title" content="Nix pill 2: install on your running system">
  <meta property="og:description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&amp;rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2014-07-24T08:38:00-07:00">
    <meta property="article:modified_time" content="2014-07-24T08:38:00-07:00">
    <meta property="article:tag" content="Nixpkgs">
    <meta property="article:tag" content="Nix">
    <meta property="article:tag" content="Nixpills">
    <meta property="article:tag" content="Nixos">

  
  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nix pill 2: install on your running system">
<meta name="twitter:description" content="Welcome to the second Nix pill. In the first pill we briefly described Nix.
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.
Nix installation is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.
Download You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: http://hydra.">

  
  

  
  <link rel="canonical" href="https://lucabrun.github.io/2014/07/nix-pill-2-install-on-your-running.html" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center">
  <div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center">
    <a class="-translate-y-[1px] text-2xl font-medium" href="https://lucabrun.github.io/"
      >Luca Bruno blog</a
    >
    <div
      class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"
    >
      

<article>
  <header class="mb-14">
    <h1 class="!my-0 pb-2.5">Nix pill 2: install on your running system</h1>

    
    <div class="text-xs antialiased opacity-60">
      
      <time>Jul 24, 2014</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>Welcome to the second Nix pill. In <a href="http://lethalman.blogspot.it/2014/07/nix-pill-1-why-you-should-give-it-try.html">the first pill</a> we briefly described Nix.<br>
Now we&rsquo;ll install Nix on our running system and understand what changed in our system after the installation.</p>
<p><a href="http://nixos.org/nix/manual/#chap-installation">Nix installation</a> is as easy as installing any other package. It will not revolutionize our system, it will stay in its own place out of our way.</p>
<h3 id="download">Download</h3>
<p>You can grab the last stable tarball (nix 1.7 during this writing) or the package for your distro here: <a href="http://hydra.nixos.org/release/nix/nix-1.7">http://hydra.nixos.org/release/nix/nix-1.7</a> .<br>
At the time you are reading, there may be nix 1.8. You can see a list of releases here: <a href="http://hydra.nixos.org/project/nix#tabs-releases">http://hydra.nixos.org/project/nix#tabs-releases</a> .</p>
<p>I prefer using the precompiled binaries, because it&rsquo;s a nice self-contained environment, just works and it&rsquo;s a little less invasive (in that it does not install anything under /etc or /usr). So in this series I will use the nix bootstrap distribution.<br>
In the download page above you can find binaries for linux i686, x86_64 and darwin.</p>
<p>Note: if you are using a rolling distribution however, I suggest not to install the package (for example on Debian sid) because you will experience broken perl dependencies when running nix tools.</p>
<h3 id="installation"><strong>Installation</strong></h3>
<p>To ensure we don&rsquo;t mess with the system, you could create a custom user to let him own the Nix store, let&rsquo;s call it &ldquo;nix&rdquo;.</p>
<p>As root:</p>
<pre tabindex="0"><code>\# adduser nix
# mkdir -m 0755 /nix &amp;&amp; chown nix /nix
</code></pre><p>From now on, all the operations we do on the shell are done from this nix user:</p>
<pre tabindex="0"><code>\# su - nix
$ tar -xf nix-1.7-x86\_64-linux.tar.bz2
$ cd nix-1.7-x86\_64-linux
$ ./install
</code></pre><p>My pills are not a simple tutorial, there&rsquo;s are several <a href="http://nixos.org/nix/manual/#chap-package-management">articles</a> <a href="https://www.domenkozar.com/2014/01/02/getting-started-with-nix-package-manager/">out</a> <a href="https://ocharles.org.uk/blog/posts/2014-02-04-how-i-develop-with-nixos.html">there</a> to learn the basics of nix and unix. We&rsquo;ll instead walk through the nix system to understand the fundamentals.</p>
<p>First thing to note: those stuff in nix store refer to software in nix store itself. It doesn&rsquo;t use libc from our system or whatelse. It&rsquo;s a self-contained nix bootstrap.</p>
<p>Quick note: in a normal installation, the store is owned by root and multiple users can install and build software through a nix daemon.</p>
<h3 id="so-small-nix-store"><strong>So small nix store</strong></h3>
<p>Start inspecting the output of the install command:</p>
<pre tabindex="0"><code>copying Nix to /nix/store..........................
</code></pre><p>Effectively, that&rsquo;s right the /nix/store we were talking in the first pill. The contents is the strictly necessary software to bootstrap a Nix system. You can see bash, core utils, the toolchain, perl libraries, sqlite and nix itself with its own tools and libnix.<br>
You surely noticed that in /nix/store not only directories are allowed, but also files, always in the form <em>hash</em>-<em>name</em>.</p>
<h3 id="the-holy-database"><strong>The holy database</strong></h3>
<p>Right after copying the store, the installation process initializes the database with the current information:</p>
<pre tabindex="0"><code>initialising Nix database...
</code></pre><p>Oh Nix also has a database. It&rsquo;s under /nix/var/nix/db. It is an sqlite database that keeps track of the dependencies between derivations.<br>
The schema is very simple: there&rsquo;s a table of valid paths, mapping from auto increment integer to store path.<br>
Then there&rsquo;s a dependency relation from one path to other paths.<br>
Inspect it running /nix/store/*sqlite*/bin/sqlite3 /nix/var/nix/db/db.sqlite</p>
<p><strong>Important rule</strong>: never change /nix/store manually because that wouldn&rsquo;t be in sync with the sqlite db, unless you know what you are doing.</p>
<h3 id="the-first-profile"><strong>The first profile</strong></h3>
<p>Then we discover the <a href="http://nixos.org/nix/manual/#sec-profiles">profile</a> concept during the installation:</p>
<pre tabindex="0"><code>creating /home/nix/.nix-profile
installing \`nix-1.7&#39;
building path(s) \`/nix/store/xxhdgml3rshn8mkaqxb86gp4r276sp9d-**user-environment**&#39;
created 6 symlinks in user environment
</code></pre><p>A profile in nix is a general and very convenient concept for realizing rollbacks. Profiles are used to compose more components that are spread among multiple paths, under a new unified path. Not only, profiles are made up of multiple generations: they are versioned. Whenever you change a profile, a new generation is created.<br>
Generations thus can be switched and rollback-ed atomatically.</p>
<p>Let&rsquo;s take a closer look at our profile:</p>
<pre tabindex="0"><code>$ ls -l ~/.nix-profile/
bin -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/bin
\[...\]
manifest.nix -&gt; /nix/store/82dg18wz250vvcxjbclgyy5yg2kfz1gw-**env-manifest.nix**
\[...\]
share -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/share
</code></pre><p>That nix-1.7 derivation in the nix store is nix itself, with binaries and libraries. The installation basically reproduced the hierarchy of the nix-1.7 derivation in the profile by means of symbolic links.<br>
The contents of this profile are special, because only one program has been installed in our profile, therefore e.g. the bin directory fully points to the only program being installed.</p>
<p>But that&rsquo;s only the contents of the latest generation of our profile. In fact, ~/.nix-profile itself is a symbolic link to /nix/var/nix/profiles/default .<br>
In turn, that&rsquo;s a symlink to default-1-link in the same directory. Yes, that means it&rsquo;s the generation #1 of the default profile.<br>
Finally that&rsquo;s a symlink to the nix store &ldquo;user-environment&rdquo; derivation that you saw printed during the installation process.</p>
<p>The manifest.nix will be meat for the next pill.</p>
<h3 id="meet-nixpkgs-expressions"><strong>Meet nixpkgs expressions</strong></h3>
<p>More wild output from the installer:</p>
<pre tabindex="0"><code>downloading Nix expressions from \`http://releases.nixos.org/nixpkgs/nixpkgs-14.10pre46060.a1a2851/nixexprs.tar.xz&#39;...
unpacking channels...
created 2 symlinks in user environment
modifying /home/nix/.profile...
</code></pre><p><a href="http://nixos.org/nix/manual/#chap-writing-nix-expressions">Nix expressions</a> are used to describe packages and how to build them. <a href="http://nixos.org/nixpkgs/">Nixpkgs</a> is the repository containing all these expressions: <a href="https://github.com/NixOS/nixpkgs">https://github.com/NixOS/nixpkgs</a> .<br>
The installer downloaded the package descriptions from commit a1a2851.</p>
<p>The second profile we meet is the channels profile. ~/.nix-defexpr/channels points to /nix/var/nix/profiles/per-user/nix/channels which points to channels-1-link which points to a nix store directory containing the downloaded nix expressions.</p>
<p>Channels are a set of packages and expressions available for download. Similar to debian stable and unstable, there&rsquo;s a stable and unstable channel. In this installation, we&rsquo;re tracking <a href="http://releases.nixos.org/nixpkgs/nixpkgs-14.10pre46060.a1a2851/">nixpkgs unstable</a>.</p>
<p>Don&rsquo;t bother yet with nix expressions.</p>
<p>Finally, for your own convenience, it modified ~/.profile to automatically enter the nix environment. What ~/.nix-profile/etc/profile.d/nix.sh really does is simply adding ~/.nix-profile/bin to PATH and ~/.nix-defexpr/channels/nixpkgs to NIX_PATH. We&rsquo;ll discuss about NIX_PATH in another pill.<br>
Read nix.sh, it&rsquo;s short.</p>
<h3 id="faq-can-i-change-nix-to-something-else">FAQ: Can I change /nix to something else?</h3>
<p>You can, but there&rsquo;s a strong reason to keep using /nix instead of a different directory. All the derivations depend on other derivations by absolute path. I remind you in <a href="http://lethalman.blogspot.it/2014/07/nix-pill-1-why-you-should-give-it-try.html">pill 1</a> that bash pointed to a glibc under /nix/store.<br>
You can see now by yourself, don&rsquo;t worry if you see multiple bash derivations:</p>
<pre tabindex="0"><code>$ ldd /nix/store/\*bash\*/bin/bash
\[...\]
</code></pre><p>Keeping the store in /nix means we can grab the binary cache from nixos.org (just like you grab packages from debian mirrors) otherwise:</p>
<ol>
<li>glibc would be installed under /foo/store</li>
<li>thus bash needs to point to glibc under /foo/store</li>
<li>the binary cache won&rsquo;t help, and we&rsquo;d have to recompile all the stuff by ourselves</li>
</ol>
<p>After all /nix is a cool place.</p>
<h3 id="conclusion">Conclusion</h3>
<p>We&rsquo;ve installed nix on our system, fully isolated and owned by the &ldquo;nix&rdquo; user as we&rsquo;re still diffident with this new system.</p>
<p>We learned some new concepts like profiles and channels. In particular, with profiles we&rsquo;re able to manage multiple generations of a composition of packages, while with channels we&rsquo;re able to download binaries from nixos.org .</p>
<p>The installation put everything under /nix, and some symlinks in the nix user home. That&rsquo;s because every user is able to install and use software in her own environment.</p>
<p>I hope I left nothing uncovered in a way that you think there&rsquo;s some kind of magic behind. It&rsquo;s all about putting components in the store and symlinking these components together.</p>
<p>Also I hope the commands in this pill were consistent with your fresh nix installation.</p>
<h3 id="next-pill">Next pill&hellip; </h3>
<p>&hellip;we will enter the nix environment and learn how to interact with the store.<br>
Pill 3 is available for <a href="http://lethalman.blogspot.it/2014/07/nix-pill-3-enter-environment.html">reading here</a>.</p>
<p>To be notified about the new pill, stay tuned on <a href="https://twitter.com/search?src=typd&amp;q=%23NixPills">#NixPills</a>, follow <a href="https://twitter.com/lethalman">@lethalman</a> or subscribe to the <a href="http://lethalman.blogspot.com/feeds/posts/default/-/nixpills">nixpills rss</a>.</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixpkgs"
      >nixpkgs</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nix"
      >nix</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixpills"
      >nixpills</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixos"
      >nixos</a
    >
    
  </footer>
  

  
  
  
  
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    
    <a class="ltr:pr-3 rtl:pl-3" href="https://lucabrun.github.io/2014/07/nix-pill-3-enter-environment.html"
      ><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Nix pill 3: enter the environment</span></a
    >
    
    
    <a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href="https://lucabrun.github.io/2014/07/nix-pill-1-why-you-should-give-it-try.html"
      ><span>Nix pill 1: why you should give it a try</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </main>

    <footer
  class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"
>
  <div class="mr-auto">
  
    &copy; 2024
    <a class="link" href="https://lucabrun.github.io/">Luca Bruno blog</a>
  
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>

  </body>
</html>

<!doctype html>































<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-us"
  dir="ltr"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Nix pill 3: enter the environment - Luca Bruno blog</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="Welcome to the third Nix pill. In the previous second pill we have installed Nix on our running system. Now we can finally play with it a little, things also apply to NixOS users.
Enter the environment In the previous pill we created a nix user, so let&rsquo;s start by switching user with su - nix. If your ~/.profile got evaluated, then you should now be able to run commands like nix-env and nix-store." />
  <meta name="author" content="Luca Bruno blog" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://lucabrun.github.io/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="https://lucabrun.github.io/theme.png" />

  
  
  
  
  

  
  
  

  
  
  <script
    defer
    src="https://lucabrun.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link
    rel="icon"
    href="https://lucabrun.github.io/favicon.ico"
  />
  <link
    rel="apple-touch-icon"
    href="https://lucabrun.github.io/apple-touch-icon.png"
  />

  
  <meta name="generator" content="Hugo 0.125.2">

  
  
  
  
  


  
  
  <meta itemprop="name" content="Nix pill 3: enter the environment">
  <meta itemprop="description" content="Welcome to the third Nix pill. In the previous second pill we have installed Nix on our running system. Now we can finally play with it a little, things also apply to NixOS users.
Enter the environment In the previous pill we created a nix user, so let&rsquo;s start by switching user with su - nix. If your ~/.profile got evaluated, then you should now be able to run commands like nix-env and nix-store.">
  <meta itemprop="datePublished" content="2014-07-25T07:37:00-07:00">
  <meta itemprop="dateModified" content="2014-07-25T07:37:00-07:00">
  <meta itemprop="wordCount" content="1315">
  <meta itemprop="keywords" content="Nixpkgs,Nix,Nixpills,Nixos">
  
  <meta property="og:url" content="https://lucabrun.github.io/2014/07/nix-pill-3-enter-environment.html">
  <meta property="og:site_name" content="Luca Bruno blog">
  <meta property="og:title" content="Nix pill 3: enter the environment">
  <meta property="og:description" content="Welcome to the third Nix pill. In the previous second pill we have installed Nix on our running system. Now we can finally play with it a little, things also apply to NixOS users.
Enter the environment In the previous pill we created a nix user, so let&amp;rsquo;s start by switching user with su - nix. If your ~/.profile got evaluated, then you should now be able to run commands like nix-env and nix-store.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
  <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2014-07-25T07:37:00-07:00">
    <meta property="article:modified_time" content="2014-07-25T07:37:00-07:00">
    <meta property="article:tag" content="Nixpkgs">
    <meta property="article:tag" content="Nix">
    <meta property="article:tag" content="Nixpills">
    <meta property="article:tag" content="Nixos">

  
  <meta name="twitter:card" content="summary"><meta name="twitter:title" content="Nix pill 3: enter the environment">
<meta name="twitter:description" content="Welcome to the third Nix pill. In the previous second pill we have installed Nix on our running system. Now we can finally play with it a little, things also apply to NixOS users.
Enter the environment In the previous pill we created a nix user, so let&rsquo;s start by switching user with su - nix. If your ~/.profile got evaluated, then you should now be able to run commands like nix-env and nix-store.">

  
  

  
  <link rel="canonical" href="https://lucabrun.github.io/2014/07/nix-pill-3-enter-environment.html" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center">
  <div class="relative z-50 ltr:mr-auto rtl:ml-auto flex items-center">
    <a class="-translate-y-[1px] text-2xl font-medium" href="https://lucabrun.github.io/"
      >Luca Bruno blog</a
    >
    <div
      class="btn-dark text-[0] ltr:ml-4 rtl:mr-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 ltr:-mr-8 rtl:-ml-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"
    >
      

<article>
  <header class="mb-14">
    <h1 class="!my-0 pb-2.5">Nix pill 3: enter the environment</h1>

    
    <div class="text-xs antialiased opacity-60">
      
      <time>Jul 25, 2014</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>Welcome to the third Nix pill. In the previous <a href="http://lethalman.blogspot.it/2014/07/nix-pill-2-install-on-your-running.html">second pill</a> we have installed Nix on our running system. Now we can finally play with it a little, things also apply to NixOS users.</p>
<h3 id="enter-the-environment">Enter the environment</h3>
<p>In the previous pill we created a nix user, so let&rsquo;s start by switching user with su - nix. If your ~/.profile got evaluated, then you should now be able to run commands like nix-env and nix-store.<br>
If that&rsquo;s not the case:</p>
<pre tabindex="0"><code>$ source ~/.nix-profile/etc/profile.d/nix.sh
</code></pre><p>I remind you, ~/.nix-profile/etc points to the nix-1.7 derivation. At this point, we are in our nix user profile.</p>
<h3 id="install-something">Install something</h3>
<p>Finally something practical! Installation in the nix environment is an interesting process. Let&rsquo;s install <a href="https://github.com/edolstra/nix-repl">nix-repl</a>, a simple command line tool for playing with the Nix language. Yes, Nix is a <a href="http://nixos.org/nix/manual/#idm47361539226272">pure, lazy, functional language,</a> not only a set of tools to manage derivations.</p>
<p>Back to the installation:</p>
<pre tabindex="0"><code>$ nix-env -i nix-repl  
installing \`nix-repl-1.7-1734e8a&#39;
these paths will be fetched (18.61 MiB download, 69.53 MiB unpacked):
\[...\]
building path(s) \`/nix/store/f01lfzbw7n0yzhsjd33xfj77li9raljv-**user-environment**&#39;
created 24 symlinks in user environment
</code></pre><p>Now you can run nix-repl. Things to notice:</p>
<ul>
<li>We did install software as user, only for the nix user.</li>
<li>It created a new user environment. That&rsquo;s a new generation of our nix user profile.</li>
<li>The <a href="http://nixos.org/nix/manual/#sec-nix-env">nix-env</a> tool manages environments, profiles and their generations.</li>
<li>We installed nix-repl by derivation name minus the version. I repeat: we did specify the <strong>derivation name</strong> (minus the version) to install.</li>
</ul>
<p>We can list generations without walking through the /nix hierarchy:</p>
<pre tabindex="0"><code>$ nix-env --list-generations
   1   2014-07-24 09:23:30   
   2   2014-07-25 08:45:01   (current)
</code></pre><p>List installed derivations:</p>
<pre tabindex="0"><code>$ nix-env -q
nix-1.7
nix-repl-1.7-1734e8a
</code></pre><p>So, where did nix-repl really got installed? which nix-repl is ~/.nix-profile/bin/nix-repl which points to the store.</p>
<p>We can also list the derivation paths with nix-env -q &ndash;out-path . So that&rsquo;s how those derivation paths are called: the <strong>output</strong> of a build.</p>
<h3 id="path-merging">Path merging</h3>
<p>At this point you sure have the necessity to run &ldquo;man&rdquo;. Even if you already have man system-wide outside of the nix environment, you can install and use it within nix with nix-env -i man. As usual, a new generation will be created, and ~/.nix-profile will point to it.</p>
<p>Let&rsquo;s inspect the <a href="http://nixos.org/nix/manual/#sec-profiles">profile</a> a bit:</p>
<pre tabindex="0"><code>$ ls -l ~/.nix-profile/
dr-xr-xr-x 2 nix nix 4096 Jan  1  1970 bin
lrwxrwxrwx 1 nix nix   55 Jan  1  1970 etc -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/etc
\[...\]
</code></pre><p>Now that&rsquo;s interesting. When only nix-1.7 was installed, bin/ was a symlink to nix-1.7. Now it&rsquo;s a real directory, no symlink.</p>
<pre tabindex="0"><code>$ ls -l ~/.nix-profile/bin/
\[...\]
man -&gt; /nix/store/83cn9ing5sc6644h50dqzzfxcs07r2jn-**man-1.6g**/bin/man
\[...\]
nix-env -&gt; /nix/store/clnpynyac3hx3a6z5lsy893p7b4rwnyf-**nix-1.7**/bin/nix-env
\[...\]
nix-repl -&gt; /nix/store/0fcl92chxbbs8axb994rg12vxddg1ivs-**nix-repl-1.7-1734e8a**/bin/nix-repl
\[...\]
</code></pre><p>All clear. nix-env merged the paths from the installed derivations. which man points to the nix profile, rather than the system man, because ~/.nix-profile/bin is at the head of $PATH.</p>
<h3 id="rollback--switch-generation">Rollback / switch generation</h3>
<p>The last command installed &ldquo;man&rdquo;. We should be at generation #3, unless you changed something in the middle. Let&rsquo;s say we want to rollback to the old generation:</p>
<pre tabindex="0"><code>$ nix-env --rollback
switching from generation 3 to 2
</code></pre><p>Now nix-env -q does not list &ldquo;man&rdquo; anymore. ls -l `which man` should now be your system installed one.</p>
<p>Enough with the joke, let&rsquo;s go back to the last generation:</p>
<pre tabindex="0"><code>$ nix-env -G 3
switching from generation 2 to 3
</code></pre><p>I invite you to read the manpage of nix-env. nix-env requires an operation to perform, then there are common options for all operations, and there are options specific to an operation.</p>
<p>You can of course also <a href="http://nixos.org/nix/manual/#idm47361539520832">delete and upgrade packages</a>.</p>
<h3 id="querying-the-store">Querying the store</h3>
<p>So far we learned how to query and manipulate the environment. But all of the environment components point to the store.</p>
<p>To query and manipulate the store, there&rsquo;s the <a href="http://nixos.org/nix/manual/#sec-nix-store">nix-store</a> command. We can do neat things, but we&rsquo;ll only see some queries for now.</p>
<p>Show direct runtime dependencies of nix-repl:</p>
<pre tabindex="0"><code>$ nix-store -q --references \`which nix-repl\`
/nix/store/94n64qy99ja0vgbkf675nyk39g9b978n-**glibc-2.19**
/nix/store/8jm0wksask7cpf85miyakihyfch1y21q-**gcc-4.8.3**
/nix/store/25lg5iqy68k25hdv17yac72kcnwlh4lm-**boehm-gc-7.2d**
/nix/store/g21di262aql6xskx15z3qiw3zh3wmjlb-**nix-1.7**
/nix/store/jxs2k83npdin18ysnd104xm4sy29m8xp-**readline-6.2**
</code></pre><p>The argument to nix-store can be anything as long as it points to the nix store. It will follow symlinks.</p>
<p>It may not make sense for you right now, but let&rsquo;s print reverse dependencies of nix-repl:</p>
<pre tabindex="0"><code>$ nix-store -q --referrers \`which nix-repl\`
/nix/store/8rj57vahlndqwg4q095x5qvfa1g4rmvr-**env-manifest.nix**
/nix/store/9c8ak2h7c6vbr9kqk8i2n96bwg55br7y-**env-manifest.nix**
/nix/store/dr1y2saask2k4y2wrmxw443302pp02z2-**user-environment**
/nix/store/f01lfzbw7n0yzhsjd33xfj77li9raljv-**user-environment**
</code></pre><p>Did you expect it? Our environments depend upon nix-repl. Yes, the environments are in the store, and since there are symlinks to nix-repl, therefore the environment depends upon nix-repl.</p>
<p>It lists two environments, generation 2 and generation 3.</p>
<p>The manifest.nix file contains metadata about the environment, such as which derivations are installed. So that nix-env can list them, upgrade or remove them. Guess what, the current manifest.nix can be found in ~/.nix-profile/manifest.nix.</p>
<h3 id="closures">Closures</h3>
<p>The closure of a derivation is the list of all dependencies, recursively, down to the bare minimum necessary to use that derivation.</p>
<pre tabindex="0"><code>$ nix-store -qR \`which man\`
\[...\]
</code></pre><p>Copying all those derivations to the nix store of another machine makes you able to run &ldquo;man&rdquo; out of the box on that other machine. That&rsquo;s the base of nix deployment, you can already foresee the potential when deploying software in the cloud (hint: nix-copy-closure and nix-store &ndash;export).</p>
<p>A nicer view of the closure:</p>
<pre tabindex="0"><code>$ nix-store -qR --tree \`which man\`
\[...\]
</code></pre><p>With the above command, you can know exactly why a <strong>runtime</strong> dependency, being it direct or indirect, has been picked for a given derivation.</p>
<p>Same applies to environments of course. As an exercise run nix-store -qR &ndash;tree ~/.nix-profile , see that the first children are direct dependencies of the user environment: the installed derivations, and the manifest.nix.</p>
<h3 id="dependency-resolution">Dependency resolution</h3>
<p>There isn&rsquo;t anything like apt which solves a SAT problem in order to satisfy dependencies with lower and upper bounds on versions. Because there&rsquo;s no need. A derivation X depends on derivation Y, always.</p>
<h3 id="fancy-disrupt">Fancy disrupt</h3>
<pre tabindex="0"><code>$ nix-env -e &#39;\*&#39;
uninstalling \`man-1.6g&#39;
uninstalling \`nix-repl-1.7-1734e8a&#39;
uninstalling \`nix-1.7&#39;
\[...\]
</code></pre><p>Ops, that uninstalled all derivations from the environment, including nix. We are not able to run nix-env, what now?</p>
<p>Environments are a convenience for the user, but Nix is still there, in the store!</p>
<p>First pick one nix-1.7 derivation: ls /nix/store/*nix-1.7, say /nix/store/g21di262aql6xskx15z3qiw3zh3wmjlb-<strong>nix-1.7</strong>.</p>
<p>The first possibility is to rollback:</p>
<pre tabindex="0"><code>$ /nix/store/g21di262aql6xskx15z3qiw3zh3wmjlb-**nix-1.7**/bin/nix-env --rollback
</code></pre><p>The second possibility is to install nix, thus creating a new generation:</p>
<pre tabindex="0"><code>$ /nix/store/g21di262aql6xskx15z3qiw3zh3wmjlb-**nix-1.7**/bin/nix-env -i /nix/store/g21di262aql6xskx15z3qiw3zh3wmjlb-**nix-1.7**
</code></pre><h3 id="channels"><strong>Channels</strong></h3>
<p>So where are we getting packages from? We said something already in <a href="http://lethalman.blogspot.it/2014/07/nix-pill-2-install-on-your-running.html">pill 2</a>. There&rsquo;s a list of channels from which we get packages, usually we use a single channel. The tool to manage channels is <a href="http://nixos.org/nix/manual/#sec-nix-channel">nix-channel</a>.</p>
<pre tabindex="0"><code>$ nix-channel --list
nixpkgs http://nixos.org/channels/nixpkgs-unstable
</code></pre><p>That&rsquo;s basically the contents of ~/.nix-channels. Note: ~/.nix-channels is not a symlink to the nix store!</p>
<p>To update the channel run nix-channel &ndash;update . It will download the new nix expressions (descriptions of the packages), create a new generation of the channels profile and unpack under ~/.nix-defexpr/channels .</p>
<p>That&rsquo;s much similar to apt-get update.</p>
<h3 id="conclusion">Conclusion</h3>
<p>We learned how to query the user environment and to manipulate it by installing and uninstalling software. Upgrading software is as straight as it gets by reading <a href="http://nixos.org/nix/manual/#idm47361539520832">the manual</a> (nix-env -u &lsquo;*&rsquo; will upgrade all packages in the environment).</p>
<p>Everytime we change the environment, a new generation gets created. Switching between generations is easy and immediate.</p>
<p>Then we queried the store. We inspected the dependencies and reverse dependencies of store paths.</p>
<p>We still see symlinks to compose paths from the nix store, our lovely trick.</p>
<p>Quick analogy with programming languages. You have the heap with all the objects, that&rsquo;s the nix store. You have objects that point to other objects, those are the derivations. Will be this the right path?</p>
<h3 id="next-pill">Next pill</h3>
<p>&hellip;we will learn the basics of the Nix language. The Nix language is used to describe how to build derivations, and it&rsquo;s the base for everything else including NixOS. Therefore it&rsquo;s very important to understand the syntax and the semantics.</p>
<p>Nix pill 4 is available for <a href="http://lethalman.blogspot.it/2014/07/nix-pill-4-basics-of-language.html">reading here</a>.</p>
<p>To be notified about the new pill, stay tuned on <a href="https://twitter.com/search?src=typd&amp;q=%23NixPills">#NixPills</a>, follow <a href="https://twitter.com/lethalman">@lethalman</a> or subscribe to the <a href="http://lethalman.blogspot.com/feeds/posts/default/-/nixpills">nixpills rss</a>.</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixpkgs"
      >nixpkgs</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nix"
      >nix</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixpills"
      >nixpills</a
    >
     
    <a
      class="mb-1.5 ltr:mr-1.5 rtl:ml-1.5 rounded-lg bg-black/[3%] px-5 py-1 no-underline hover:bg-black/[6%] dark:bg-white/[8%] dark:hover:bg-white/[12%]"
      href="https://lucabrun.github.io/tags/nixos"
      >nixos</a
    >
    
  </footer>
  

  
  
  
  
  <nav
    class="mt-24 flex overflow-hidden rounded-xl bg-black/[3%] text-lg !leading-[1.2] *:flex *:w-1/2 *:items-center *:p-5 *:font-medium *:no-underline dark:bg-white/[8%] [&>*:hover]:bg-black/[2%] dark:[&>*:hover]:bg-white/[3%]"
  >
    
    <a class="ltr:pr-3 rtl:pl-3" href="https://lucabrun.github.io/2014/07/nix-pill-4-basics-of-language.html"
      ><span class="ltr:mr-1.5 rtl:ml-1.5">←</span><span>Nix pill 4: the basics of the language</span></a
    >
    
    
    <a class="ltr:ml-auto rtl:mr-auto justify-end pl-3" href="https://lucabrun.github.io/2014/07/nix-pill-2-install-on-your-running.html"
      ><span>Nix pill 2: install on your running system</span><span class="ltr:ml-1.5 rtl:mr-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  


  
</article>


    </main>

    <footer
  class="mx-auto flex h-[4.5rem] max-w-[--w] items-center px-8 text-xs uppercase tracking-wider opacity-60"
>
  <div class="mr-auto">
  
    &copy; 2024
    <a class="link" href="https://lucabrun.github.io/">Luca Bruno blog</a>
  
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >powered by hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >hugo-paper</a
  >
</footer>

  </body>
</html>
